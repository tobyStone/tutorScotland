<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tutors Alliance Scotland - Blog Writer</title>
    <link rel="icon" href="/images/bannerShield2.png" type="image/png">
    <link rel="stylesheet" href="/style.css">
    <script src="/responsive-helper.js"></script>

    <!--
      1) A placeholder script block for JSON-LD microdata.
         We'll populate this dynamically based on the user’s form input.
    -->
    <script id="blogMicrodata" type="application/ld+json"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <!-- Shared banner/header -->
    <header>
        <h1>Tutors Alliance Scotland</h1>
        <div class="header-links">
            <a href="index.html" class="banner-login-link login-box">Home</a>
            <a href="login.html?role=admin" class="banner-login-link login-box">Login</a>
        </div>
    </header>

    <!-- Dark-blue nav below banner -->
    <nav class="main-nav">
        <ul>
            <li><a href="about-us.html">About Us</a></li>
            <li><a href="tutorMembership.html">Tutor Membership</a></li>
            <li><a href="parents.html">Enter Parent Zone</a></li>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="tutorDirectory.html">Tutor Directory</a></li>
        </ul>
    </nav>

    <!-- Rolling banner container -->
    <div class="rolling-banner">
        <div class="rolling-content" id="tutorBanner">
            <!-- JS can populate tutor names/subjects here -->
        </div>
    </div>

    <main>
        <!-- A single form to create a new blog post, with extra fields for microdata -->
        <section id="newBlogSection">
            <h2>Create a New Blog Post</h2>
            <form id="blogForm">
                <label>
                    Title:
                    <input type="text" id="titleField" name="title" required>
                </label>

                <label>
                    Author:
                    <input type="text" id="authorField" name="author" placeholder="e.g. John Smith" required>
                </label>

                <!-- New Category Field -->
                <label>
                    Category:
                    <select id="categoryField" name="category">
                        <option value="general">General</option>
                        <option value="parent">Parent</option>
                        <option value="tutor">Tutor</option>
                    </select>
                </label>

                <label>
                    Excerpt (short summary):
                    <textarea id="excerptField" name="excerpt" rows="2" maxlength="200"
                              placeholder="A short teaser or summary of the post."></textarea>
                </label>

                <label>
                    Publish Date/Time:
                    <input type="datetime-local" id="publishDateField" name="publishDate">
                </label>

                <label>
                    Content:
                    <textarea id="contentField" name="content" rows="5" cols="50" required></textarea>
                </label>

                <label>
                    Image:
                    <input type="file" id="imageField" accept="image/*">
                </label>

                <button type="submit">Create Blog</button>
            </form>

        </section>
    </main>

    <script type="module">
        import { uploadImage } from '/js/upload-helper.js';

        const blogForm = document.getElementById('blogForm');
        const blogMicrodata = document.getElementById('blogMicrodata');

        blogForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            /* 1. Gather user input */
            const title = document.getElementById('titleField').value.trim();
            const author = document.getElementById('authorField').value.trim();
            const category = document.getElementById('categoryField').value;
            const excerpt = document.getElementById('excerptField').value.trim();
            const publishDate = document.getElementById('publishDateField').value;
            const content = document.getElementById('contentField').value.trim();

            /* 2. Upload image first (if any) */
            const imageFile = document.getElementById('imageField').files[0];
            const imagePath = imageFile ? await uploadImage(imageFile, 'blog') : '';

            /* 3. Build JSON‑LD */
            const domain = 'https://tutorsalliancescotland.co.uk';
            const nowISO = new Date().toISOString();

            const jsonLdObj = {
                "@context": "https://schema.org",
                "@type": "BlogPosting",
                "mainEntityOfPage": { "@type": "WebPage", "@id": `${domain}/blog` },
                "headline": title,
                "author": { "@type": "Person", "name": author || "Tutors Alliance Scotland" },
                "publisher": {
                    "@type": "Organization",
                    "name": "Tutors Alliance Scotland",
                    "logo": { "@type": "ImageObject", "url": `${domain}/images/bannerShield2.png` }
                },
                "datePublished": publishDate ? new Date(publishDate).toISOString() : nowISO,
                "dateModified": nowISO,
                "description": excerpt || (content.slice(0, 160) + '…'),
                "image": imagePath || `${domain}/images/defaultBlog.png`
            };

            blogMicrodata.textContent = JSON.stringify(jsonLdObj, null, 2);

            /* 4. Send blog to server */
            const payload = { title, author, category, excerpt, publishDate, content, imagePath };
            const res = await fetch('/api/blog-writer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const msg = await res.text();
                alert(`Error: ${msg}`);
                return;
            }

            const data = await res.json();
            alert(data.message || 'Blog created!');
            blogForm.reset();
            blogMicrodata.textContent = '';
        });
    </script>

</body>
</html>
