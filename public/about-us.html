<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TASâ€¯AdminÂ â€“Â Dashboard</title>

    <!-- favicon & css -->
    <link rel="icon" href="/images/bannerShield2.png" type="image/png" />
    <link rel="stylesheet" href="/style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/responsive-helper.js" defer></script>

    <style>
        /* lilac panel used by both forms */
        .admin-form-container {
            max-width: 700px;
            margin: 40px auto;
            background: #C8A2C8;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,.1)
        }

            .admin-form-container h3 {
                margin-top: 0
            }

        form label {
            display: block;
            margin-top: 14px;
            font-weight: bold
        }

        form input, form textarea, form select {
            width: 100%;
            padding: 9px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 4px
        }

        form button {
            margin-top: 20px;
            padding: 12px 20px;
            background: #0057B7;
            color: #fff;
            border: 0;
            border-radius: 4px;
            font-size: 1.05em;
            cursor: pointer;
            transition: .25s
        }

            form button:hover {
                background: #0046a5;
                box-shadow: 0 0 8px #C8A2C8
            }

        /* small table that lists existing dynamic sections */
        table#sectionTable {
            width: 100%;
            margin-top: 25px;
            border-collapse: collapse;
            font-size: .93em
        }

        #sectionTable th, #sectionTable td {
            border: 1px solid #ddd;
            padding: 6px
        }

        #sectionTable th {
            background: #ececec;
            text-align: left
        }

        #sectionTable button {
            background: none;
            border: 0;
            font-size: 1.2em;
            cursor: pointer
        }

            #sectionTable button:hover {
                color: #b00
            }
    </style>
</head>

<body>
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER/BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header>
        <h1>Tutors Alliance Scotland</h1>
        <div class="header-links">
            <a class="banner-login-link login-box" href="/">Home</a>
            <a class="banner-login-link login-box" href="/login.html?role=admin">Login</a>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="/about-us.html">AboutÂ Us</a></li>
            <li><a href="/tutorMembership.html">TutorÂ Membership</a></li>
            <li><a href="/parents.html">EnterÂ ParentÂ Zone</a></li>
            <li><a href="/contact.html">ContactÂ Us</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="/tutorDirectory.html">TutorÂ Directory</a></li>
        </ul>
    </nav>

    <div class="rolling-banner">
        <div class="rolling-content" id="tutorBanner"></div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <main>
        <!-- â–‘â–‘â–‘â–‘â–‘â–‘ ADDâ€‘TUTOR FORM â–‘â–‘â–‘â–‘â–‘â–‘ -->
        <div class="admin-form-container">
            <h3>Add a Tutor</h3>

            <!-- handled completely in JS  -->
            <form id="tutorForm" autocomplete="off">
                <label>TutorÂ Name:<input type="text" name="name" required /></label>

                <label>
                    SubjectsÂ (commaâ€‘separated):
                    <input type="text" name="subjects" required />
                </label>

                <label>
                    CostÂ RangeÂ (e.g.Â Â£,Â Â£Â£):
                    <input type="text" name="costRange" />
                </label>

                <label>
                    BadgesÂ (commaâ€‘separated):
                    <input type="text" name="badges" />
                </label>

                <label>
                    TutorÂ Image:
                    <input type="file" id="imageField" accept="image/*" />
                </label>

                <label>
                    ContactÂ (emailÂ orÂ website):
                    <input type="text" name="contact" />
                </label>

                <label>Description:<textarea name="description"></textarea></label>

                <label>
                    PostcodesÂ (commaâ€‘separated):
                    <input type="text" name="postcodes" />
                </label>

                <button type="submit">AddÂ Tutor</button>
            </form>
        </div>

        <!-- â–‘â–‘â–‘â–‘â–‘â–‘  ADDâ€‘/DELETEÂ SECTION  â–‘â–‘â–‘â–‘â–‘â–‘ -->
        <div class="admin-form-container">
            <h3>Add a Dynamic Section</h3>

            <!-- â˜… NEW â€“ simplified form : only page, heading, paragraph, image â˜… -->
            <form id="addSection" enctype="multipart/form-data" autocomplete="off">
                <label>
                    Target Page:
                    <select name="page" id="pageSelect">
                        <!-- add more options if you create new pages -->
                        <option value="index">index</option>
                        <option value="about-us">aboutâ€‘us</option>
                        <option value="tutorMembership">tutorMembership</option>
                    </select>
                </label>

                <label>Heading:<input name="heading" required></label>
                <label>Paragraph:<textarea name="text" rows="3" required></textarea></label>
                <label>Image:<input type="file" name="image" accept="image/*"></label>

                <button>Add Section</button>
            </form>

            <!-- â˜… NEW â€“ table of existing sections with a delete button â˜… -->
            <h3 style="margin-top:35px">Existing sections for this page</h3>
            <table id="sectionTable">
                <thead>
                    <tr><th>#</th><th>Heading</th><th>Image?</th><th></th></tr>
                </thead>
                <tbody><!-- filled by JS --></tbody>
            </table>
        </div>
    </main>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  MODULE SCRIPT  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script type="module">
        import { uploadImage } from '/js/upload-helper.js';

        /* â”€â”€ pageâ€‘guard: only admins allowed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const auth = await fetch('/api/protected?role=admin');
        if (!auth.ok) { location.href = '/login.html?role=admin'; throw 0; }

        /* â”€â”€ rolling banner text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        fetch('/api/tutors?format=json')
            .then(r => r.json())
            .then(list => {
                tutorBanner.textContent =
                    list.map(t => `${t.name} (${t.subjects.join(', ')})`).join(' | ');
            })
            .catch(console.error);

        /* â–‘â–‘â–‘ 1. ADDâ€‘TUTOR WORKFLOW  â–‘â–‘â–‘ */
        tutorForm.addEventListener('submit', async e => {
            e.preventDefault();
            const fd = new FormData(tutorForm);
            const csv = s => s.split(',').map(x => x.trim()).filter(Boolean);

            /* optional image upload */
            let imagePath = '';
            if (imageField.files[0]) {
                const f = imageField.files[0];
                if (f.size > 2 * 1024 * 1024) return alert('Image >â€¯2â€¯MB');
                try { imagePath = await uploadImage(f, 'tutors'); }
                catch (err) { return alert(err.message); }
            }

            const payload = {
                name: fd.get('name').trim(),
                subjects: csv(fd.get('subjects')),
                costRange: fd.get('costRange').trim(),
                badges: csv(fd.get('badges')),
                contact: fd.get('contact').trim(),
                description: fd.get('description').trim(),
                postcodes: csv(fd.get('postcodes')),
                imagePath
            };

            const r = await fetch('/api/addTutor', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!r.ok) return alert(await r.text());
            alert('Tutor added!');
            tutorForm.reset();
        });

        /* â–‘â–‘â–‘ 2. ADD / DELETE  SECTIONS â–‘â–‘â–‘ */
        const pageSel = document.getElementById('pageSelect');
        const sectionTbody = document.querySelector('#sectionTable tbody');

        /* helper loads list for current <select> value */
        async function loadSections() {
            const r = await fetch(`/api/sections?page=${pageSel.value}`);
            if (!r.ok) { alert(await r.text()); return; }
            const list = await r.json();

            sectionTbody.innerHTML = '';
            list.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                       <td>${i + 1}</td>
                       <td>${s.heading}</td>
                       <td>${s.image ? 'âœ”ï¸' : ''}</td>
                       <td><button data-id="${s._id}">ğŸ—‘ï¸</button></td>`;
                sectionTbody.appendChild(tr);
            });
        }
        await loadSections();
        pageSel.addEventListener('change', loadSections);

        /* addâ€‘section submit */
        addSection.addEventListener('submit', async e => {
            e.preventDefault();
            const fd = new FormData(addSection);

            /* upload image first (optional) */
            const img = fd.get('image') instanceof File && fd.get('image').size ? fd.get('image') : null;
            if (img) {
                try {
                    const url = await uploadImage(img, 'sections');
                    fd.set('imagePath', url);          // server expects this field
                } catch (err) { return alert(err.message); }
            }

            fd.delete('image');                       // raw file not sent to server
            const r = await fetch('/api/sections', { method: 'POST', body: fd });
            if (!r.ok) return alert(await r.text());
            alert('Section added!');
            addSection.reset();
            loadSections();
        });

        /* delete click */
        sectionTbody.addEventListener('click', async e => {
            if (!e.target.dataset.id) return;
            if (!confirm('Delete this section?')) return;
            const r = await fetch(`/api/sections/${e.target.dataset.id}`, { method: 'DELETE' });
            if (r.ok) loadSections(); else alert(await r.text());
        });
    </script>
</body>
</html>
